<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan prix â†’ â‚¬ (PWA) â€” ROI</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#fafafa;color:#111827}
    header{padding:12px 16px;background:#111827;color:#fff}
    main{padding:16px;display:grid;gap:12px;max-width:920px;margin:auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.05);background:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:12px 16px;border-radius:12px;border:1px solid #111827;background:#111827;color:#fff;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6}
    select,input{padding:10px 12px;border-radius:12px;border:1px solid #d1d5db}
    #wrap{position:relative}
    #preview{width:100%;aspect-ratio:3/4;background:#000;border-radius:12px}
    #roi{position:absolute;inset:0;pointer-events:none}
    .mask{position:absolute;inset:0;background:rgba(0,0,0,.35);border-radius:12px}
    .hole{position:absolute;border:2px dashed #22d3ee;box-shadow:0 0 0 9999px rgba(0,0,0,.35);border-radius:10px}
    .label{position:absolute;left:50%;transform:translateX(-50%);top:8px;background:#111827;color:#fff;font-size:.8rem;padding:2px 8px;border-radius:999px}
    #output{font-size:1.2rem}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <strong>Scanner prix â†’ conversion (â‚¬) â€” fenÃªtre de scan ciblÃ©e</strong>
  </header>
  <main>
    <section class="card">
      <div class="row">
        <button id="startBtn">Activer la camÃ©ra</button>
        <button id="scanBtn" disabled>Scanner</button>
        <label>
          Devise cible
          <select id="target">
            <option value="EUR" selected>EUR (â‚¬)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (Â£)</option>
            <option value="CZK">CZK (KÄ)</option>
          </select>
        </label>
        <label>
          Largeur fenÃªtre
          <input type="range" id="roiW" min="30" max="90" value="60"/>
        </label>
        <label>
          Hauteur fenÃªtre
          <input type="range" id="roiH" min="6" max="20" value="10"/>
        </label>
        <span class="pill">OCR ligne (PSM 7) + taux en direct</span>
      </div>

      <div id="wrap">
        <video id="preview" playsinline></video>
        <canvas id="frame" hidden></canvas>
        <svg id="roi" viewBox="0 0 100 100" preserveAspectRatio="none">
          <rect class="mask" x="0" y="0" width="100" height="100" fill="none" />
          <rect id="hole" class="hole" x="20" y="45" width="60" height="10" rx="3" ry="3" />
          <text class="label" x="50" y="8">Cadre la ligne du prix</text>
        </svg>
      </div>
      <p id="hint" class="muted">La zone active est la <strong>fenÃªtre bleue</strong> (â‰ˆ une ligne ~10 caractÃ¨res). Ajuste sa taille avec les curseurs si besoin.</p>
    </section>

    <section class="card">
      <div id="output" class="muted">Aucune donnÃ©e scannÃ©e pour lâ€™instant.</div>
      <div id="details" class="muted" style="font-size:.95rem"></div>
    </section>

    <section class="card">
      <h3>Conseils</h3>
      <ul>
        <li>Place uniquement le <strong>prix</strong> dans la fenÃªtre bleue (Ã©vite les autres lignes).</li>
        <li>Ã‰vite les reflets ; bouge lÃ©gÃ¨rement pour lâ€™autofocus.</li>
        <li>Devise auto (KÄ/CZK/â‚¬/$/Â£). Par dÃ©faut: CZK si non dÃ©tectÃ©e.</li>
      </ul>
    </section>
  </main>

<script>
const video = document.getElementById('preview');
const canvas = document.getElementById('frame');
const out = document.getElementById('output');
const details = document.getElementById('details');
const startBtn = document.getElementById('startBtn');
const scanBtn = document.getElementById('scanBtn');
const targetSel = document.getElementById('target');
const roiW = document.getElementById('roiW');
const roiH = document.getElementById('roiH');
const hole = document.getElementById('hole');

let stream;

function updateHole(){
  const w = parseInt(roiW.value,10); // pourcentage
  const h = parseInt(roiH.value,10);
  const x = (100 - w)/2;
  const y = (100 - h)/2;
  hole.setAttribute('x', String(x));
  hole.setAttribute('y', String(y));
  hole.setAttribute('width', String(w));
  hole.setAttribute('height', String(h));
}
roiW.addEventListener('input', updateHole);
roiH.addEventListener('input', updateHole);
updateHole();

const CURRENCY_HINTS = [
  { code: 'EUR', match: /(â‚¬|\beur\b|\beuro\b)/i },
  { code: 'CZK', match: /(\bczk\b|kÄ|\bkc\b|koruna|couronne)/i },
  { code: 'USD', match: /(\$|\busd\b|\bus\s*d\b)/i },
  { code: 'GBP', match: /(Â£|\bgbp\b|pound|livre)/i },
];

function extractAmountAndCurrency(text){
  const line = text.replace(/\n+/g,' ').trim();
  const numberRegex = /([0-9]{1,3}(?:[\s.,][0-9]{3})*|[0-9]+)(?:[\s.,][0-9]{1,2})?/g;
  const candidates = [];
  let m; while ((m = numberRegex.exec(line)) !== null) candidates.push({raw:m[0], idx:m.index});
  if(candidates.length===0) return null;
  let cur = 'CZK';
  for (const hint of CURRENCY_HINTS){ if (hint.match.test(line)) { cur = hint.code; break; } }
  candidates.sort((a,b)=>b.raw.length-a.raw.length);
  const pick = candidates[0];
  const normalized = pick.raw.replace(/\s/g,'').replace(',', '.');
  const amount = parseFloat(normalized);
  if (isNaN(amount)) return null;
  return { amount, srcCur: cur, raw: line };
}

async function getRate(src, tgt){
  if(src===tgt) return 1;
  const url = `https://api.frankfurter.app/latest?amount=1&from=${encodeURIComponent(src)}&to=${encodeURIComponent(tgt)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Taux introuvable');
  const data = await res.json();
  return data.rates[tgt];
}

async function doScan(){
  details.textContent = 'Lectureâ€¦';
  scanBtn.disabled = true;

  const vw = video.videoWidth, vh = video.videoHeight;
  canvas.width = vw; canvas.height = vh;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, vw, vh);

  const wPct = parseFloat(hole.getAttribute('width'));
  const hPct = parseFloat(hole.getAttribute('height'));
  const xPct = parseFloat(hole.getAttribute('x'));
  const yPct = parseFloat(hole.getAttribute('y'));
  const rx = Math.round(vw * xPct / 100);
  const ry = Math.round(vh * yPct / 100);
  const rw = Math.round(vw * wPct / 100);
  const rh = Math.round(vh * hPct / 100);

  const crop = document.createElement('canvas');
  crop.width = rw; crop.height = rh;
  const cctx = crop.getContext('2d');
  cctx.drawImage(canvas, rx, ry, rw, rh, 0, 0, rw, rh);

  try{
    const { data: { text } } = await Tesseract.recognize(crop, 'eng+fra', {
      logger: ()=>{},
      tessedit_pageseg_mode: 7,
    });
    const parsed = extractAmountAndCurrency(text);
    if(!parsed){
      out.innerHTML = 'ğŸ˜• Rien dâ€™exploitable. Ajuste la fenÃªtre sur la ligne exacte du prix.';
      details.textContent = '';
      return;
    }
    const tgt = targetSel.value;
    const rate = await getRate(parsed.srcCur, tgt);
    const converted = parsed.amount * rate;
    out.innerHTML = `ğŸ§® <strong>${parsed.amount.toFixed(2)} ${parsed.srcCur}</strong> â‰ˆ <strong>${converted.toFixed(2)} ${tgt}</strong>`;
    details.innerHTML = `Taux: 1 ${parsed.srcCur} = ${rate.toFixed(4)} ${tgt}<br><span class="muted">OCR: ${parsed.raw.substring(0,180).replace(/</g,'&lt;')}â€¦</span>`;
  }catch(err){
    out.textContent = 'Erreur: ' + err.message;
    details.textContent = '';
  }finally{
    scanBtn.disabled = false;
  }
}

startBtn.addEventListener('click', async ()=>{
  try{
    const media = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    stream = media; video.srcObject = stream; await video.play();
    scanBtn.disabled = false; startBtn.disabled = true;
  }catch(e){
    alert('Impossible dâ€™accÃ©der Ã  la camÃ©ra. VÃ©rifie les permissions et HTTPS.');
  }
});

scanBtn.addEventListener('click', doScan);
</script>

<link rel="manifest" href="data:application/manifest+json,{\"name\":\"Scan prix â†’ â‚¬\",\"short_name\":\"ScanPrix\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#111827\",\"theme_color\":\"#111827\"}">
</body>
</html>

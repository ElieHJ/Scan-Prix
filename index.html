<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan prix ‚Üí ‚Ç¨ (fen√™tre cibl√©e)</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    html,body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      background:#fafafa;
      color:#111827;
    }
    header{padding:12px 16px;background:#111827;color:#fff;}
    main{padding:16px;display:grid;gap:12px;max-width:920px;margin:auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.05);background:#fff}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{
      padding:12px 16px;border-radius:12px;border:1px solid #111827;
      background:#111827;color:#fff;font-weight:600;cursor:pointer
    }
    button:disabled{opacity:.6}
    select,input{padding:10px 12px;border-radius:12px;border:1px solid #d1d5db}
    #wrap{position:relative}
    #preview{width:100%;aspect-ratio:3/4;background:#000;border-radius:12px}
    #roi{position:absolute;inset:0;pointer-events:none}
    .mask{fill:rgba(0,0,0,0.5);}
    .hole{stroke:#22d3ee;stroke-width:2;fill:transparent;}
    .label{fill:#fff;font-size:4px;text-anchor:middle}
    #output{font-size:1.2rem}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <strong>Scanner prix ‚Üí conversion (‚Ç¨)</strong>
  </header>
  <main>
    <section class="card">
      <div class="row">
        <button id="startBtn">Activer la cam√©ra</button>
        <button id="scanBtn" disabled>Scanner</button>
        <label>
          Devise cible
          <select id="target">
            <option value="EUR" selected>EUR (‚Ç¨)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (¬£)</option>
            <option value="CZK">CZK (Kƒç)</option>
          </select>
        </label>
        <label>Largeur fen√™tre
          <input type="range" id="roiW" min="30" max="90" value="60"/>
        </label>
        <label>Hauteur fen√™tre
          <input type="range" id="roiH" min="6" max="20" value="10"/>
        </label>
        <span class="pill">OCR ligne (PSM 7)</span>
      </div>

      <div id="wrap">
        <video id="preview" playsinline></video>
        <canvas id="frame" hidden></canvas>
        <svg id="roi" viewBox="0 0 100 100" preserveAspectRatio="none">
          <rect class="mask" width="100" height="100"/>
          <rect id="hole" class="hole" x="20" y="45" width="60" height="10" rx="3" ry="3"/>
          <text class="label" x="50" y="10">Cadre la ligne du prix</text>
        </svg>
      </div>
      <p id="hint" class="muted">
        Place uniquement le prix dans la <strong>bande bleue transparente</strong>.
        Ajuste la largeur/hauteur si besoin.
      </p>
    </section>

    <section class="card">
      <div id="output" class="muted">Aucune donn√©e scann√©e pour l‚Äôinstant.</div>
      <div id="details" class="muted" style="font-size:.95rem"></div>
    </section>
  </main>

<script>
const video = document.getElementById('preview');
const canvas = document.getElementById('frame');
const out = document.getElementById('output');
const details = document.getElementById('details');
const startBtn = document.getElementById('startBtn');
const scanBtn = document.getElementById('scanBtn');
const targetSel = document.getElementById('target');
const roiW = document.getElementById('roiW');
const roiH = document.getElementById('roiH');
const hole = document.getElementById('hole');

function updateHole(){
  const w = parseInt(roiW.value,10);
  const h = parseInt(roiH.value,10);
  const x = (100 - w)/2;
  const y = (100 - h)/2;
  hole.setAttribute('x', x);
  hole.setAttribute('y', y);
  hole.setAttribute('width', w);
  hole.setAttribute('height', h);
}
roiW.addEventListener('input', updateHole);
roiH.addEventListener('input', updateHole);
updateHole();

const CURRENCY_HINTS = [
  { code: 'EUR', match: /(‚Ç¨|eur|euro)/i },
  { code: 'CZK', match: /(czk|kƒç|kc|koruna|couronne)/i },
  { code: 'USD', match: /($|usd|us\\s*d)/i },
  { code: 'GBP', match: /(¬£|gbp|pound|livre)/i },
];

function extractAmountAndCurrency(text){
  const numberRegex = /([0-9]{1,3}(?:[\\s.,][0-9]{3})*|[0-9]+)(?:[\\s.,][0-9]{1,2})?/g;
  const candidates = [];
  let m;
  while ((m = numberRegex.exec(text)) !== null) candidates.push({raw:m[0]});
  let cur = 'CZK';
  for (const hint of CURRENCY_HINTS){ if (hint.match.test(text)) { cur = hint.code; break; } }
  const pick = candidates.at(-1);
  if(!pick) return null;
  const amount = parseFloat(pick.raw.replace(/\\s/g,'').replace(',', '.'));
  if (isNaN(amount)) return null;
  return { amount, srcCur: cur };
}

async function getRate(src, tgt){
  if(src===tgt) return 1;
  const res = await fetch(`https://api.frankfurter.app/latest?amount=1&from=${src}&to=${tgt}`);
  const data = await res.json();
  return data.rates[tgt];
}

async function doScan(){
  details.textContent = 'Lecture‚Ä¶';
  scanBtn.disabled = true;

  const vw = video.videoWidth, vh = video.videoHeight;
  canvas.width = vw; canvas.height = vh;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, vw, vh);

  const wPct = parseFloat(hole.getAttribute('width'));
  const hPct = parseFloat(hole.getAttribute('height'));
  const xPct = parseFloat(hole.getAttribute('x'));
  const yPct = parseFloat(hole.getAttribute('y'));
  const rx = Math.round(vw * xPct / 100);
  const ry = Math.round(vh * yPct / 100);
  const rw = Math.round(vw * wPct / 100);
  const rh = Math.round(vh * hPct / 100);

  const crop = document.createElement('canvas');
  crop.width = rw; crop.height = rh;
  crop.getContext('2d').drawImage(canvas, rx, ry, rw, rh, 0, 0, rw, rh);

  try{
    const { data: { text } } = await Tesseract.recognize(crop, 'eng+fra', {
      tessedit_pageseg_mode: 7
    });
    const parsed = extractAmountAndCurrency(text);
    if(!parsed){ out.textContent='Rien d‚Äôexploitable'; details.textContent=''; return; }
    const rate = await getRate(parsed.srcCur, targetSel.value);
    const converted = parsed.amount * rate;
    out.innerHTML = `üßÆ <strong>${parsed.amount.toFixed(2)} ${parsed.srcCur}</strong> ‚âà <strong>${converted.toFixed(2)} ${targetSel.value}</strong>`;
    details.textContent = `Taux : 1 ${parsed.srcCur} = ${rate.toFixed(4)} ${targetSel.value}`;
  }catch(err){ out.textContent = 'Erreur: '+err.message; }
  finally{ scanBtn.disabled = false; }
}

startBtn.addEventListener('click', async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream; await video.play();
    scanBtn.disabled = false; startBtn.disabled = true;
  }catch(e){ alert('Impossible d‚Äôacc√©der √† la cam√©ra'); }
});

scanBtn.addEventListener('click', doScan);
</script>
</body>
</html>

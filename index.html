<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan prix ‚Üí ‚Ç¨ (v10: zoom par d√©faut + ic√¥nes)</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#fafafa;color:#111827}
    /* Barre haute, bouton cam√©ra centr√© */
    header{position:sticky;top:0;z-index:30;padding:10px;background:#111827;color:#fff;display:flex;justify-content:center}
    #startBtn{padding:10px 16px;border-radius:9999px;border:1px solid #374151;background:#111827;color:#fff;font-weight:700}

    main{padding:10px;display:grid;gap:12px;max-width:920px;margin:auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;box-shadow:0 4px 14px rgba(0,0,0,.05);background:#fff}

    /* Zone vid√©o large */
    #wrap{position:relative;height:74vh;max-height:84vh;border-radius:12px;overflow:hidden;background:#000}
    #preview{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block}
    #overlay{position:absolute;inset:0;pointer-events:none}

    .veil{fill:rgba(0,0,0,.22)}
    .hole-stroke{fill:none;stroke:#22d3ee;stroke-width:0.9}

    /* Bouton scan flottant (en bas √† droite) */
    .fab{position:absolute;z-index:7;width:52px;height:52px;border-radius:9999px;border:none;background:#111827;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-size:22px}
    #scanFloat{right:10px;bottom:10px}

    /* Pastille sous la fen√™tre (5s) */
    #roiResult{position:absolute;z-index:6;color:#fff;padding:6px 10px;border-radius:10px;font-weight:800;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;transition:opacity .18s ease, background-color .18s ease; text-align:center}
    #roiResult.show{opacity:1}

    /* Barre d‚Äôic√¥nes au-dessus du ROI */
    .roiToolbar{position:absolute;z-index:8;display:flex;gap:8px;align-items:center;transform:translate(-50%, -120%)}
    .iconBtn{width:40px;height:40px;border-radius:9999px;border:none;background:#111827;color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-size:18px}
    .chip{min-width:44px;height:28px;display:flex;align-items:center;justify-content:center;padding:0 8px;border-radius:9999px;background:#111827;color:#fff;font-weight:700;font-size:13px;border:1px solid #374151}

    /* Sliders compacts avec ic√¥nes (sans texte) */
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .ctrl{display:flex;gap:6px;align-items:center}
    .ctrl input[type=range]{width:160px}

    #output{font-size:1.1rem}
    .muted{color:#6b7280}
  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <button id="startBtn">Activer la cam√©ra</button>
  </header>

  <main>
    <section class="card">
      <div id="wrap">
        <video id="preview" playsinline></video>
        <canvas id="frame" hidden></canvas>

        <!-- R√©sultat 5s align√© sur la fen√™tre -->
        <div id="roiResult"></div>

        <!-- Barre d‚Äôic√¥nes flottante au-dessus du ROI -->
        <div id="roiToolbar" class="roiToolbar" aria-label="outils">
          <button id="zoomOut" class="iconBtn" title="Zoom -">‚ûñ</button>
          <div id="zoomChip" class="chip">1.5√ó</div>
          <button id="zoomIn" class="iconBtn" title="Zoom +">‚ûï</button>
          <button id="swapCur" class="iconBtn" title="EUR ‚áÑ CZK">‚ÜîÔ∏è</button>
          <button id="presetFine" class="iconBtn" title="Ligne fine">‚â°</button>
          <button id="toggleFS" class="iconBtn" title="Plein √©cran">‚õ∂</button>
        </div>

        <!-- Bouton scan -->
        <button id="scanFloat" class="fab" title="Scanner" aria-label="Scanner">üîç</button>

        <!-- Overlay masque avec trou -->
        <svg id="overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
          <defs>
            <mask id="cutout">
              <rect x="0" y="0" width="100" height="100" fill="white"/>
              <rect id="holeMask" x="14" y="45" width="72" height="10" fill="black" rx="2" ry="2"/>
            </mask>
          </defs>
          <rect x="0" y="0" width="100" height="100" class="veil" mask="url(#cutout)"/>
          <rect id="holeStroke" x="14" y="45" width="72" height="10" class="hole-stroke" rx="2" ry="2"/>
        </svg>
      </div>
    </section>

    <section class="card">
      <!-- Contr√¥les compacts (ic√¥nes seulement) -->
      <div class="controls">
        <div class="ctrl" title="Largeur fen√™tre">
          <span>‚ÜîÔ∏è</span>
          <input type="range" id="roiW" min="30" max="95" value="72"/>
        </div>
        <div class="ctrl" title="Hauteur fen√™tre">
          <span>‚ÜïÔ∏è</span>
          <input type="range" id="roiH" min="4" max="18" value="10"/>
        </div>
        <div class="ctrl" title="Devise cible">
          <span>üí±</span>
          <select id="target">
            <option value="EUR" selected>EUR</option>
            <option value="CZK">CZK</option>
            <option value="USD">USD</option>
            <option value="GBP">GBP</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <div id="output" class="muted">Aucune donn√©e scann√©e pour l‚Äôinstant.</div>
      <div id="details" class="muted" style="font-size:.95rem"></div>
    </section>
  </main>

<script>
const video = document.getElementById('preview');
const canvas = document.getElementById('frame');
const out = document.getElementById('output');
const details = document.getElementById('details');
const startBtn = document.getElementById('startBtn');
const scanFloat = document.getElementById('scanFloat');
const targetSel = document.getElementById('target');
const roiW = document.getElementById('roiW');
const roiH = document.getElementById('roiH');
const holeMask = document.getElementById('holeMask');
const holeStroke = document.getElementById('holeStroke');
const wrap = document.getElementById('wrap');
const roiResult = document.getElementById('roiResult');
const toolbar = document.getElementById('roiToolbar');
const zoomIn = document.getElementById('zoomIn');
const zoomOut = document.getElementById('zoomOut');
const zoomChip = document.getElementById('zoomChip');
const presetFine = document.getElementById('presetFine');
const swapCur = document.getElementById('swapCur');
const toggleFS = document.getElementById('toggleFS');

const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
let stream=null; let hideTimer=null;
// Zoom OCR (agrandit la ROI pour la lecture) avec d√©faut 1.5√ó
let zoomFactor = 1.5; // plage 1.0 ‚Üí 3.0

// ROI en % et verrouillage
let roi = { x:14, y:45, w:72, h:10 };

function applyRoi(){
  roi.w = clamp(roi.w, 10, 95); roi.h = clamp(roi.h, 4, 22);
  roi.x = clamp(roi.x, 0.5, 99.5 - roi.w); roi.y = clamp(roi.y, 0.5, 99.5 - roi.h);
  for(const el of [holeMask, holeStroke]){ el.setAttribute('x', roi.x); el.setAttribute('y', roi.y); el.setAttribute('width', roi.w); el.setAttribute('height', roi.h); }
  positionWidgets();
}
function positionWidgets(){
  const r = wrap.getBoundingClientRect();
  // Toolbar centr√©e au-dessus du trou
  const cx = r.width * (roi.x + roi.w/2) / 100;
  const cy = r.height * (roi.y) / 100;
  toolbar.style.left = cx + 'px';
  toolbar.style.top  = cy + 'px';
  // Pastille sous la fen√™tre
  const rrLeft = r.width * (roi.x) / 100;
  let rrTop = r.height * (roi.y + roi.h + 1.5) / 100;
  const rrWidth = r.width * (roi.w) / 100;
  if(rrTop + 36 > r.height) rrTop = r.height * (roi.y + roi.h - 1.5) / 100 - 30;
  roiResult.style.left = Math.round(rrLeft) + 'px';
  roiResult.style.top  = Math.round(rrTop) + 'px';
  roiResult.style.width= Math.max(120, Math.round(rrWidth)) + 'px';
}

function syncInputs(){ roiW.value = roi.w; roiH.value = roi.h; }
function updateFromInputs(){ roi.w=parseInt(roiW.value,10); roi.h=parseInt(roiH.value,10); roi.x=(100-roi.w)/2; roi.y=(100-roi.h)/2; applyRoi(); }
roiW.addEventListener('input', updateFromInputs); roiH.addEventListener('input', updateFromInputs);
window.addEventListener('resize', positionWidgets);

presetFine.addEventListener('click', ()=>{ roi.w=80; roi.h=6; roi.x=(100-roi.w)/2; roi.y=(100-roi.h)/2; syncInputs(); applyRoi(); });
swapCur.addEventListener('click', ()=>{ const v=targetSel.value; targetSel.value = (v==='EUR') ? 'CZK' : (v==='CZK' ? 'EUR' : 'EUR'); });

// Zoom boutons (+/-) pour OCR
function setZoom(z){ zoomFactor = clamp(parseFloat(z.toFixed(2)), 1.0, 3.0); zoomChip.textContent = zoomFactor+'√ó'; }
zoomIn.addEventListener('click', ()=> setZoom(zoomFactor+0.25));
zoomOut.addEventListener('click', ()=> setZoom(zoomFactor-0.25));
setZoom(zoomFactor);

// Drag ROI
let dragging=false, start={x:0,y:0}, roiStart={x:0,y:0};
function pt(e){ const t=e.touches?e.touches[0]:e; const rect=wrap.getBoundingClientRect(); return {px:clamp((t.clientX-rect.left)/rect.width*100,0,100), py:clamp((t.clientY-rect.top)/rect.height*100,0,100)}; }
function onDown(e){ const {px,py}=pt(e); if(px>=roi.x && px<=roi.x+roi.w && py>=roi.y && py<=roi.y+roi.h){ dragging=true; start={x:px,y:py}; roiStart={x:roi.x,y:roi.y}; e.preventDefault(); } }
function onMove(e){ if(!dragging) return; const {px,py}=pt(e); roi.x = roiStart.x + (px-start.x); roi.y = roiStart.y + (py-start.y); applyRoi(); e.preventDefault(); }
function onUp(){ dragging=false; }
wrap.addEventListener('mousedown', onDown); wrap.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
wrap.addEventListener('touchstart', onDown, {passive:false}); wrap.addEventListener('touchmove', onMove, {passive:false}); wrap.addEventListener('touchend', onUp);

const CURRENCY_HINTS=[{code:'EUR',match:/(‚Ç¨|\\beur\\b|\\beuro\\b)/i},{code:'CZK',match:/(\\bczk\\b|kƒç|\\bkc\\b|koruna|couronne)/i},{code:'USD',match:/(\\$|\\busd\\b|\\bus\\s*d\\b)/i},{code:'GBP',match:/(¬£|\\bgbp\\b|pound|livre)/i}];
function extractAmountAndCurrency(text){ const line=text.replace(/\\n+/g,' ').trim(); const numberRegex=/([0-9]{1,3}(?:[\\s.,][0-9]{3})*|[0-9]+)(?:[\\s.,][0-9]{1,2})?/g; const candidates=[]; let m; while((m=numberRegex.exec(line))!==null) candidates.push({raw:m[0]}); if(!candidates.length) return null; let cur='CZK'; for(const h of CURRENCY_HINTS){ if(h.match.test(line)){cur=h.code;break;} } candidates.sort((a,b)=>b.raw.length-a.raw.length); const pick=candidates[0]; const amount=parseFloat(pick.raw.replace(/\\s/g,'').replace(',', '.')); if(isNaN(amount)) return null; return {amount,srcCur:cur,raw:line}; }
async function getRate(src,tgt){ if(src===tgt) return 1; const url=`https://api.frankfurter.app/latest?amount=1&from=${encodeURIComponent(src)}&to=${encodeURIComponent(tgt)}`; const res=await fetch(url); if(!res.ok) throw new Error('Taux introuvable'); const data=await res.json(); return data.rates[tgt]; }

function badgeCss(cur){
  switch(cur){
    case 'CZK': return 'linear-gradient(90deg, rgba(6,182,212,.92), rgba(8,145,178,.92))';
    case 'EUR': return 'linear-gradient(90deg, rgba(22,163,74,.92), rgba(21,128,61,.92))';
    case 'USD': return 'linear-gradient(90deg, rgba(245,158,11,.92), rgba(217,119,6,.92))';
    case 'GBP': return 'linear-gradient(90deg, rgba(139,92,246,.92), rgba(124,58,237,.92))';
    default: return 'rgba(17,24,39,.88)';
  }
}

async function doScan(){
  details.textContent='Lecture‚Ä¶'; scanFloat.disabled=true; roiResult.classList.remove('show'); if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; }
  const vw=video.videoWidth, vh=video.videoHeight; if(!vw||!vh){ details.textContent='Cam√©ra non pr√™te'; scanFloat.disabled=false; return; }
  canvas.width=vw; canvas.height=vh; const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,vw,vh);
  const rx=Math.round(vw*roi.x/100), ry=Math.round(vh*roi.y/100), rw=Math.round(vw*roi.w/100), rh=Math.round(vh*roi.h/100);
  const crop=document.createElement('canvas'); const cctx=crop.getContext('2d');
  const outW = Math.round(rw*zoomFactor), outH = Math.round(rh*zoomFactor);
  crop.width=outW; crop.height=outH; cctx.imageSmoothingEnabled=true; cctx.drawImage(canvas,rx,ry,rw,rh,0,0,outW,outH);
  try{
    const {data:{text}}=await Tesseract.recognize(crop,'eng+fra',{tessedit_pageseg_mode:7});
    const parsed=extractAmountAndCurrency(text); if(!parsed){ out.textContent='Rien d\\'exploitable'; details.textContent=''; return; }
    const tgt=targetSel.value; const rate=await getRate(parsed.srcCur,tgt); const converted=parsed.amount*rate;
    roiResult.textContent=`${parsed.amount.toFixed(2)} ${parsed.srcCur} ‚âà ${converted.toFixed(2)} ${tgt}`;
    roiResult.style.background = badgeCss(parsed.srcCur);
    positionWidgets(); roiResult.classList.add('show'); hideTimer=setTimeout(()=>roiResult.classList.remove('show'),5000);
    out.innerHTML=`üßÆ <strong>${parsed.amount.toFixed(2)} ${parsed.srcCur}</strong> ‚âà <strong>${converted.toFixed(2)} ${tgt}</strong>`;
    details.innerHTML=`Taux: 1 ${parsed.srcCur} = ${rate.toFixed(4)} ${tgt}<br><span class="muted">OCR: ${parsed.raw.substring(0,160).replace(/</g,'&lt;')}‚Ä¶</span>`;
  }catch(err){ out.textContent='Erreur: '+err.message; details.textContent=''; }
  finally{ scanFloat.disabled=false; }
}

startBtn.addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    video.srcObject = stream; await video.play();
    scanFloat.addEventListener('click', doScan);
    applyRoi();
  }catch(e){ alert('Impossible d\\'acc√©der √† la cam√©ra. V√©rifie les permissions et HTTPS.'); }
});

toggleFS.addEventListener('click', async ()=>{
  document.body.classList.add('fullscreen');
  if(document.documentElement.requestFullscreen){ try{ await document.documentElement.requestFullscreen(); }catch{} }
  positionWidgets();
});
document.addEventListener('fullscreenchange', ()=>{ if(!document.fullscreenElement){ document.body.classList.remove('fullscreen'); positionWidgets(); } });

// init
(function(){ applyRoi(); })();
</script>
</body>
</html>
<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan prix ‚Üí ‚Ç¨ (v9: r√©sultat 5s sous la fen√™tre)</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    :root{ --veil: rgba(0,0,0,.22); --accent:#22d3ee; --bg:#fafafa; --ink:#111827 }
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--ink)}
    header{padding:10px 14px;background:#111827;color:#fff}
    main{padding:10px;display:grid;gap:12px;max-width:920px;margin:auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:10px;box-shadow:0 4px 14px rgba(0,0,0,.05);background:#fff}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:12px;border:1px solid #111827;background:#111827;color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:#fff;color:#111827;border-color:#d1d5db}
    button:disabled{opacity:.6}
    select,input{padding:8px 10px;border-radius:12px;border:1px solid #d1d5db}/* Fen√™tre cam√©ra large */
#wrap{position:relative;height:72vh;max-height:78vh;border-radius:12px;overflow:hidden;background:#000}
#preview{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:contain;display:block}
#overlay{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none}

.veil{fill:var(--veil)}
.hole-stroke{fill:none;stroke:var(--accent);stroke-width:0.9}

/* Bouton scan flottant */
#scanFloat{position:absolute;z-index:6;width:52px;height:52px;border-radius:9999px;border:none;background:#111827;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;font-size:22px;pointer-events:auto}

/* Pastille de r√©sultat: s'aligne sur la largeur de la fen√™tre et reste 5s */
#roiResult{position:absolute;z-index:6;pointer-events:none;color:#fff;padding:6px 10px;border-radius:10px;font-weight:800;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.25);opacity:0;transition:opacity .18s ease, background-color .18s ease; text-align:center}
#roiResult.show{opacity:1}

#output{font-size:1.15rem}
.muted{color:#6b7280}
.pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}

/* PLEIN √âCRAN (h√©rit√©e) */
body.fullscreen header, body.fullscreen .controls{display:none}
body.fullscreen main{max-width:none;padding:0}
body.fullscreen #wrap{height:92vh;max-height:100vh;border-radius:0}
#fsBar{display:none;position:fixed;left:0;top:0;width:100%;padding:8px 10px;background:rgba(17,24,39,.65);color:#fff;z-index:20;backdrop-filter: blur(4px)}
body.fullscreen #fsBar{display:flex;justify-content:space-between;align-items:center}

  </style>
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <strong>Scanner prix ‚Üí conversion (‚Ç¨)</strong>
  </header>  <div id="fsBar">
    <span>Mode plein √©cran</span>
    <div style="display:flex;gap:8px">
      <button id="scanFloatFs" title="Scanner" aria-label="Scanner">üîç</button>
      <button id="exitFS" class="ghost">Quitter</button>
    </div>
  </div>  <main>
    <section class="card controls">
      <div class="row">
        <button id="startBtn">Activer la cam√©ra</button>
        <label>Devise cible
          <select id="target">
            <option value="EUR" selected>EUR (‚Ç¨)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (¬£)</option>
            <option value="CZK">CZK (Kƒç)</option>
          </select>
        </label>
        <button id="swapCur" class="ghost" title="Basculer EUR‚áÑCZK">EUR ‚áÑ CZK</button>
        <label>Largeur <input type="range" id="roiW" min="30" max="95" value="72"/></label>
        <label>Hauteur <input type="range" id="roiH" min="4" max="18" value="10"/></label>
        <button id="presetFine" class="ghost" title="Ligne tr√®s fine">Ligne tr√®s fine</button>
        <button id="toggleZoom" class="ghost" title="Zoom 2√ó dans la fen√™tre">Zoom 2√ó: OFF</button>
        <button id="toggleFS" class="ghost" title="Plein √©cran (masque l‚ÄôUI)">Plein √©cran</button>
        <span class="pill">Fen√™tre d√©pla√ßable + OCR ligne</span>
      </div>
    </section><section class="card">
  <div id="wrap">
    <video id="preview" playsinline></video>
    <canvas id="frame" hidden></canvas>
    <button id="scanFloat" title="Scanner" aria-label="Scanner">üîç</button>
    <div id="roiResult"></div>
    <svg id="overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
      <defs>
        <mask id="cutout">
          <rect x="0" y="0" width="100" height="100" fill="white"/>
          <rect id="holeMask" x="14" y="45" width="72" height="10" fill="black" rx="2" ry="2"/>
        </mask>
      </defs>
      <rect x="0" y="0" width="100" height="100" class="veil" mask="url(#cutout)"/>
      <rect id="holeStroke" x="14" y="45" width="72" height="10" class="hole-stroke" rx="2" ry="2"/>
    </svg>
  </div>
</section>

<section class="card">
  <div id="output" class="muted">Aucune donn√©e scann√©e pour l‚Äôinstant.</div>
  <div id="details" class="muted" style="font-size:.95rem"></div>
</section>

  </main><script>
const video = document.getElementById('preview');
const canvas = document.getElementById('frame');
const out = document.getElementById('output');
const details = document.getElementById('details');
const startBtn = document.getElementById('startBtn');
const scanFloat = document.getElementById('scanFloat');
const scanFloatFs = document.getElementById('scanFloatFs');
const exitFS = document.getElementById('exitFS');
const toggleFS = document.getElementById('toggleFS');
const swapCur = document.getElementById('swapCur');
const targetSel = document.getElementById('target');
const roiW = document.getElementById('roiW');
const roiH = document.getElementById('roiH');
const presetFine = document.getElementById('presetFine');
const toggleZoom = document.getElementById('toggleZoom');
const holeMask = document.getElementById('holeMask');
const holeStroke = document.getElementById('holeStroke');
const wrap = document.getElementById('wrap');
const roiResult = document.getElementById('roiResult');

const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
let zoom2x=false; let stream=null; let hideTimer=null;
let roi = { x:14, y:45, w:72, h:10 };

function badgeCss(cur){
  switch(cur){
    case 'CZK': return 'linear-gradient(90deg, rgba(6,182,212,.92), rgba(8,145,178,.92))';
    case 'EUR': return 'linear-gradient(90deg, rgba(22,163,74,.92), rgba(21,128,61,.92))';
    case 'USD': return 'linear-gradient(90deg, rgba(245,158,11,.92), rgba(217,119,6,.92))';
    case 'GBP': return 'linear-gradient(90deg, rgba(139,92,246,.92), rgba(124,58,237,.92))';
    default:    return 'rgba(17,24,39,.88)';
  }
}

function positionWidgets(){
  const r = wrap.getBoundingClientRect();
  // Position bouton scan √† droite de la fen√™tre
  const leftPx = r.width * (roi.x + roi.w + 1.5) / 100;
  const topPx  = r.height * (roi.y + roi.h/2) / 100;
  scanFloat.style.left = clamp(leftPx, 8, r.width - 60) + 'px';
  scanFloat.style.top  = clamp(topPx - 26, 8, r.height - 60) + 'px';
  // Pastille: align√©e sur la largeur de la fen√™tre, coll√©e juste SOUS le bord inf√©rieur
  const rrLeft = r.width * (roi.x) / 100;
  let rrTop = r.height * (roi.y + roi.h + 1.5) / 100; // 1.5% sous le trou
  const rrWidth = r.width * (roi.w) / 100;
  // Si √ßa d√©passe en bas, place DANS la fen√™tre, 1.5% au-dessus du bord
  if(rrTop + 36 > r.height) rrTop = r.height * (roi.y + roi.h - 1.5) / 100 - 30;
  roiResult.style.left = Math.round(rrLeft) + 'px';
  roiResult.style.top  = Math.round(rrTop) + 'px';
  roiResult.style.width= Math.max(120, Math.round(rrWidth)) + 'px';
}

function applyRoi(){
  roi.w = clamp(roi.w, 10, 95); roi.h = clamp(roi.h, 4, 22);
  roi.x = clamp(roi.x, 0.5, 99.5 - roi.w); roi.y = clamp(roi.y, 0.5, 99.5 - roi.h);
  for(const el of [holeMask, holeStroke]){ el.setAttribute('x', roi.x); el.setAttribute('y', roi.y); el.setAttribute('width', roi.w); el.setAttribute('height', roi.h); }
  positionWidgets();
}

function updateFromInputs(){ roi.w = parseInt(roiW.value,10); roi.h = parseInt(roiH.value,10); roi.x = (100 - roi.w)/2; roi.y = (100 - roi.h)/2; applyRoi(); }
function syncInputs(){ roiW.value = roi.w; roiH.value = roi.h; }
roiW.addEventListener('input', updateFromInputs); roiH.addEventListener('input', updateFromInputs);
window.addEventListener('resize', positionWidgets);

presetFine.addEventListener('click', ()=>{ roi.w=80; roi.h=6; roi.x=(100-roi.w)/2; roi.y=(100-roi.h)/2; syncInputs(); applyRoi(); });

toggleZoom.addEventListener('click', ()=>{ zoom2x=!zoom2x; toggleZoom.textContent='Zoom 2√ó: '+(zoom2x?'ON':'OFF'); });

swapCur.addEventListener('click', ()=>{ const v=targetSel.value; targetSel.value = (v==='EUR') ? 'CZK' : (v==='CZK' ? 'EUR' : 'EUR'); });

// Drag ROI
let dragging=false, start={x:0,y:0}, roiStart={x:0,y:0};
function pt(e){ const t=e.touches?e.touches[0]:e; const rect=wrap.getBoundingClientRect(); return {px:clamp((t.clientX-rect.left)/rect.width*100,0,100), py:clamp((t.clientY-rect.top)/rect.height*100,0,100)}; }
function onDown(e){ const {px,py}=pt(e); if(px>=roi.x && px<=roi.x+roi.w && py>=roi.y && py<=roi.y+roi.h){ dragging=true; start={x:px,y:py}; roiStart={x:roi.x,y:roi.y}; e.preventDefault(); } }
function onMove(e){ if(!dragging) return; const {px,py}=pt(e); roi.x = roiStart.x + (px-start.x); roi.y = roiStart.y + (py-start.y); applyRoi(); e.preventDefault(); }
function onUp(){ dragging=false; }
wrap.addEventListener('mousedown', onDown); wrap.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp);
wrap.addEventListener('touchstart', onDown, {passive:false}); wrap.addEventListener('touchmove', onMove, {passive:false}); wrap.addEventListener('touchend', onUp);

const CURRENCY_HINTS=[{code:'EUR',match:/(‚Ç¨|\beur\b|\beuro\b)/i},{code:'CZK',match:/(\bczk\b|kƒç|\bkc\b|koruna|couronne)/i},{code:'USD',match:/(\$|\busd\b|\bus\s*d\b)/i},{code:'GBP',match:/(¬£|\bgbp\b|pound|livre)/i}];
function extractAmountAndCurrency(text){ const line=text.replace(/\n+/g,' ').trim(); const numberRegex=/([0-9]{1,3}(?:[\s.,][0-9]{3})*|[0-9]+)(?:[\s.,][0-9]{1,2})?/g; const candidates=[]; let m; while((m=numberRegex.exec(line))!==null) candidates.push({raw:m[0]}); if(!candidates.length) return null; let cur='CZK'; for(const h of CURRENCY_HINTS){ if(h.match.test(line)){cur=h.code;break;} } candidates.sort((a,b)=>b.raw.length-a.raw.length); const pick=candidates[0]; const amount=parseFloat(pick.raw.replace(/\s/g,'').replace(',', '.')); if(isNaN(amount)) return null; return {amount,srcCur:cur,raw:line}; }
async function getRate(src,tgt){ if(src===tgt) return 1; const url=`https://api.frankfurter.app/latest?amount=1&from=${encodeURIComponent(src)}&to=${encodeURIComponent(tgt)}`; const res=await fetch(url); if(!res.ok) throw new Error('Taux introuvable'); const data=await res.json(); return data.rates[tgt]; }

async function doScan(){
  details.textContent='Lecture‚Ä¶'; scanFloat.disabled=true; if(scanFloatFs) scanFloatFs.disabled=true;
  if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; }
  roiResult.classList.remove('show');
  const vw=video.videoWidth, vh=video.videoHeight; if(!vw||!vh){ details.textContent='Cam√©ra non pr√™te'; scanFloat.disabled=false; if(scanFloatFs) scanFloatFs.disabled=false; return; }
  canvas.width=vw; canvas.height=vh; const ctx=canvas.getContext('2d'); ctx.drawImage(video,0,0,vw,vh);
  const rx=Math.round(vw*roi.x/100), ry=Math.round(vh*roi.y/100), rw=Math.round(vw*roi.w/100), rh=Math.round(vh*roi.h/100);
  const crop=document.createElement('canvas'); const cctx=crop.getContext('2d');
  if(zoom2x){ crop.width=rw*2; crop.height=rh*2; cctx.imageSmoothingEnabled=true; cctx.drawImage(canvas,rx,ry,rw,rh,0,0,rw*2,rh*2); }
  else { crop.width=rw; crop.height=rh; cctx.drawImage(canvas,rx,ry,rw,rh,0,0,rw,rh); }
  try{
    const {data:{text}}=await Tesseract.recognize(crop,'eng+fra',{tessedit_pageseg_mode:7});
    const parsed=extractAmountAndCurrency(text); if(!parsed){ out.textContent='Rien d\'exploitable'; details.textContent=''; return; }
    const tgt=targetSel.value; const rate=await getRate(parsed.srcCur,tgt); const converted=parsed.amount*rate;
    // Pastille 5s sous la fen√™tre, align√©e sur sa largeur
    roiResult.textContent=`${parsed.amount.toFixed(2)} ${parsed.srcCur} ‚âà ${converted.toFixed(2)} ${tgt}`;
    roiResult.style.background = badgeCss(parsed.srcCur);
    positionWidgets();
    roiResult.classList.add('show');
    hideTimer = setTimeout(()=>{ roiResult.classList.remove('show'); }, 5000);

    out.innerHTML=`üßÆ <strong>${parsed.amount.toFixed(2)} ${parsed.srcCur}</strong> ‚âà <strong>${converted.toFixed(2)} ${tgt}</strong>`;
    details.innerHTML=`Taux: 1 ${parsed.srcCur} = ${rate.toFixed(4)} ${tgt}<br><span class="muted">OCR: ${parsed.raw.substring(0,160).replace(/</g,'&lt;')}‚Ä¶</span>`;
  }catch(err){ out.textContent='Erreur: '+err.message; details.textContent=''; }
  finally{ scanFloat.disabled=false; if(scanFloatFs) scanFloatFs.disabled=false; }
}

startBtn.addEventListener('click', async ()=>{ try{ stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } }); video.srcObject=stream; await video.play(); scanFloat.addEventListener('click', doScan); if(scanFloatFs) scanFloatFs.addEventListener('click', doScan); applyRoi(); }catch(e){ alert('Impossible d\'acc√©der √† la cam√©ra. V√©rifie les permissions et HTTPS.'); } });

// Plein √©cran
async function enterFullscreen(){ document.body.classList.add('fullscreen'); if(document.documentElement.requestFullscreen){ try{ await document.documentElement.requestFullscreen(); }catch{} } positionWidgets(); }
async function exitFullscreen(){ document.body.classList.remove('fullscreen'); if(document.fullscreenElement){ try{ await document.exitFullscreen(); }catch{} } positionWidgets(); }
if(toggleFS) toggleFS.addEventListener('click', enterFullscreen);
if(exitFS) exitFS.addEventListener('click', exitFullscreen);

// init
(function(){ applyRoi(); })();
</script></body>
</html>
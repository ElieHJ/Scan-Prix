<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Scan prix → € (PWA)</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;}
    header{padding:12px 16px;background:#111827;color:#fff;}
    main{padding:16px;display:grid;gap:12px;max-width:920px;margin:auto}
    .card{border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 4px 14px rgba(0,0,0,.05)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:12px 16px;border-radius:12px;border:1px solid #111827;background:#111827;color:#fff;font-weight:600}
    button:disabled{opacity:.6}
    select,input{padding:10px 12px;border-radius:12px;border:1px solid #d1d5db}
    #preview{width:100%;aspect-ratio:3/4;background:#000;border-radius:12px}
    #output{font-size:1.2rem}
    .muted{color:#6b7280}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#f3f4f6;border:1px solid #e5e7eb}
    .ok{color:#065f46}
    .warn{color:#92400e}
    footer{padding:24px;text-align:center;color:#6b7280}
    code{background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;padding:2px 6px}
  </style>
  <!-- Tesseract.js OCR -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <header>
    <strong>Scanner prix → conversion (€)</strong>
  </header>
  <main>
    <section class="card">
      <div class="row">
        <button id="startBtn">Activer la caméra</button>
        <button id="scanBtn" disabled>Scanner</button>
        <label>
          Devise cible
          <select id="target">
            <option value="EUR" selected>EUR (€)</option>
            <option value="USD">USD ($)</option>
            <option value="GBP">GBP (£)</option>
            <option value="CZK">CZK (Kč)</option>
          </select>
        </label>
        <span class="pill">Reconnaissance OCR + taux en direct</span>
      </div>
      <video id="preview" playsinline></video>
      <canvas id="frame" hidden></canvas>
      <p id="hint" class="muted">Cadre une étiquette, un menu, un ticket… puis appuie sur <em>Scanner</em>.</p>
    </section>

    <section class="card">
      <div id="output" class="muted">Aucune donnée scannée pour l’instant.</div>
      <div id="details" class="muted" style="font-size:.95rem"></div>
    </section>

    <section class="card">
      <h3>Conseils</h3>
      <ul>
        <li>Laisse la caméra faire la mise au point. Évite les reflets.</li>
        <li>L’app détecte automatiquement CZK/Kč/€/$/£. Si la devise n’est pas trouvée, elle suppose CZK (configurable).</li>
        <li>Fonctionne en HTTPS (exigence navigateur pour la caméra). En local, <code>localhost</code> suffit.</li>
      </ul>
    </section>
  </main>
  <footer>© Toi. Installe sur l’écran d’accueil : menu navigateur → « Ajouter à l’écran d’accueil ».</footer>

<script>
const video = document.getElementById('preview');
const canvas = document.getElementById('frame');
const out = document.getElementById('output');
const details = document.getElementById('details');
const startBtn = document.getElementById('startBtn');
const scanBtn = document.getElementById('scanBtn');
const targetSel = document.getElementById('target');

let stream;

const CURRENCY_HINTS = [
  { code: 'EUR', match: /(€|eur|euro)/i },
  { code: 'CZK', match: /(czk|kč|kc|koruna|couronne)/i },
  { code: 'USD', match: /($|usd|us\s*d)/i },
  { code: 'GBP', match: /(£|gbp|pound|livre)/i },
];

function extractAmountAndCurrency(text){
  // 1) Trouver un nombre (avec , ou . et espaces) le plus « crédible »
  const numberRegex = /([0-9]{1,3}(?:[\s.,][0-9]{3})*|[0-9]+)(?:[\s.,][0-9]{1,2})?/g;
  const candidates = [];
  let m;
  while ((m = numberRegex.exec(text)) !== null) candidates.push({raw:m[0], idx:m.index});
  // Heuristique : prendre le plus proche d’un symbole monnaie
  let cur = 'CZK'; // défaut: couronne tchèque (modifiable)
  for (const hint of CURRENCY_HINTS){ if (hint.match.test(text)) { cur = hint.code; break; } }
  // Choisir dernier nombre trouvé (souvent le prix final)
  const pick = candidates.at(-1);
  if(!pick) return null;
  const normalized = pick.raw.replace(/\s/g,'').replace(',', '.');
  const amount = parseFloat(normalized);
  if (isNaN(amount)) return null;
  return { amount, srcCur: cur };
}

async function getRate(src, tgt){
  if(src===tgt) return 1;
  // Frankfurter (Banque centrale européenne). Exemple d’API publique.
  const url = `https://api.frankfurter.app/latest?amount=1&from=${encodeURIComponent(src)}&to=${encodeURIComponent(tgt)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Taux introuvable');
  const data = await res.json();
  return data.rates[tgt];
}

async function doScan(){
  details.textContent = 'Lecture…';
  scanBtn.disabled = true;
  // Capture un frame
  const w = video.videoWidth, h = video.videoHeight;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);

  try{
    const { data: { text } } = await Tesseract.recognize(canvas, 'eng+fra', { logger: ()=>{} });
    const parsed = extractAmountAndCurrency(text);
    if(!parsed){
      out.innerHTML = '😕 Rien d’exploitable. Re-essaie en cadrant mieux.';
      details.textContent = '';
      return;
    }
    const tgt = targetSel.value;
    const rate = await getRate(parsed.srcCur, tgt);
    const converted = parsed.amount * rate;
    out.innerHTML = `🧮 <strong>${parsed.amount.toFixed(2)} ${parsed.srcCur}</strong> ≈ <strong>${converted.toFixed(2)} ${tgt}</strong>`;
    details.innerHTML = `Taux: 1 ${parsed.srcCur} = ${rate.toFixed(4)} ${tgt}<br><span class="muted">Texte OCR détecté : ${text.substring(0,180).replace(/</g,'&lt;')}…</span>`;
  }catch(err){
    out.textContent = 'Erreur: ' + err.message;
    details.textContent = '';
  }finally{
    scanBtn.disabled = false;
  }
}

startBtn.addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream; await video.play();
    scanBtn.disabled = false; startBtn.disabled = true;
  }catch(e){
    alert('Impossible d’accéder à la caméra. Vérifie les permissions et HTTPS.');
  }
});

scanBtn.addEventListener('click', doScan);
</script>

<!-- Manifeste PWA minimal (facultatif) -->
<link rel="manifest" href="data:application/manifest+json,{\"name\":\"Scan prix → €\",\"short_name\":\"ScanPrix\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#111827\",\"theme_color\":\"#111827\"}">
</body>
</html>
